<!DOCTYPE html>
<!--
    Francois Maillet, 2016-02-25
    Copyright (c) 2016 Datacratic Inc. All rights reserved.
-->
<html lang="en">
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Classifier Builder</title>
</head>
<body>
 <div class="container">
<h1>Classifier Builder</h1>
<h3>Dataset selection</h3>

<div class="row">
  <div class="col-sm-6 col-md-4">
    <div class="thumbnail well">
        <p>
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/realestate/office_building-12.jpg" alt="...">
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/realestate/beach_house-4.jpg" alt="...">
        </p>
      <div class="caption">
        <h3>Real estate</h3>
        <p>
            <a href="#" class="btn btn-primary builtin" role="button" id="realestate">Use dataset</a>
        </p>
      </div>
    </div>
  </div>

   <div class="col-sm-6 col-md-4">
    <div class="thumbnail well">
        <p>
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/recipe/salad_recipe-18.jpg" alt="...">
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/recipe/eggs_recipe-1.jpg" alt="...">
        </p>
      <div class="caption">
        <h3>Recipes</h3>
        <p><a href="#" class="btn btn-primary builtin" role="button" id="recipe">Use dataset</a>
        <br><br>
        </p>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-sm-6 col-md-4">
    <div class="thumbnail well">
        <p>
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/pets/boxer_132.jpg" alt="...">
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/pets/Maine_Coon_77.jpg" alt="...">
        </p>
      <div class="caption">
        <h3>Pets</h3>
        <p><a href="#" class="btn btn-primary builtin" role="button" id="pets">Use dataset</a>
<br><br>
        </p>
      </div>
    </div>
  </div>

   <div class="col-sm-6 col-md-4">
    <div class="thumbnail well">
        <p>
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/transport/sports_car_wallpaper-12.jpg" alt="...">
          <img src="https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images/transport/bulldozer_wallpaper-13.jpg" alt="...">
        </p>
      <div class="caption">
        <h3>Transportation</h3>
        <p><a href="#" class="btn btn-primary builtin" role="button" id="transport">Use dataset</a>
        </p>
      </div>
    </div>
  </div>

</div>

<div class="row">
  <div class="col-sm-12 col-md-8">
    <div class="thumbnail well">
      <div class="caption">
        <h3>Upload your own images!</h3>
        <form>
            <div class="form-group">
                <label for="collectionName">Dataset name</label>
                <input class="form-control" id="collectionName" placeholder="Name">
            </div>
            <div class="form-group">
                <label for="imageLimit">Limit</label>
                <input class="form-control" id="imageLimit" placeholder="100">
                 <p class="help-block">Maximum number of images to process. With 32 cores, it goes at about 25 images per second. -1 for no limit.</p>
            </div>
             <div class="form-group">
                 <label for="filesToUpload">Your images</label>
                 <input type="file" id="filesToUpload" multiple>
                 <p class="help-block">You can only upload JPEG images.</p>
            </div>
            <button type="button" id="uploadButton" class="btn btn-primary" onclick="$.uploadFiles()">
                <span class="glyphicon glyphicon-upload"></span>
                Upload
            </button>
            <img src="gears.gif" id="gears">
            <span id="status"></span>
        </p>
      </div>
    </div>
  </div>
</div>

</div>
<script>

imgPrefix = "https://s3.amazonaws.com/public-mldb-ai/datasets/dataset-builder/images";

$( document ).ready(function() {
    $("#gears").hide();
    $(".builtin").click(function(x) {
        window.location.href = window.location.href.split("/").slice(0, -1).join("/") + "/dataset_builder.html?"+
                "prefix=" + encodeURIComponent(imgPrefix) +
                "&dataset=" + x.target.id;
    });


    $.uploadFiles = function(){
        var preview = document.querySelector('img'); //selects the query named img
        var files    = document.querySelector('input[type=file]').files; //sames as here

        if(files.length < 2) {
            alert("Must select at least 2 images!");
            return;
        }

        if($('#collectionName').val().length == 0) {
            alert("Must give a dataset name!");
            return;
        }

        // we're reading so update the ui
        $("#gears").show();
        $("#uploadButton").text('Processing...');
        $("#uploadButton").prop('disabled', true);
        $("#status").html('Loading data locally...');


        var num_images = files.length;
        var image_data = [];

        var reader  = new FileReader();
        function readAndUpload(fileId, file) {
            // Make sure the file is a jpeg
            if (!( /\.(jpe?g)$/i.test(file.name))) {
                console.log("skipping " + file.name + " because extension is wrong!");
                num_images--;
                return;
            }

            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function (event) {
                var result = event.target.result;
                image_data.push([file.name, result]);
            }
        }

        for(var i=0; i<files.length; i++)
            readAndUpload(i, files[i]);

        var doPost = function() {
            // if we're not done preparing, return for now
            if(image_data.length != num_images) {
                return;
            }

            // we're ready to go! clear timeout
            clearTimeout(waitTillCanUpload);

            $("#status").html('Uploading and processing images... This can take a while :)');
            $.ajax({
                method: "POST",
                url: window.location.href.split("/").slice(0, -2).join("/") + "/createDataset",
                data: JSON.stringify({
                    "dataset": $('#collectionName').val(),
                    "images": image_data,
                    "limit": $('#imageLimit').val()
                }),
                dataType: "json",
                error: function(msg) {
                    alert( "An exception occured :(\n" +
                        JSON.stringify(JSON.parse(msg.responseText), null, 2));
                    $("#status").html('An error occured');
                    $("#uploadButton").prop('disabled', false);
                    $("#gears").hide();
                },
                success: function(e) {
                    window.location.href = window.location.href.split("/").slice(0, -1).join("/") + "/dataset_builder.html?"+
                            "prefix="+encodeURIComponent(window.location.href.split("/").slice(0, -1).join("/"))+
                            "&dataset=" + e.name;
                },
            });
        }

        var waitTillCanUpload = setTimeout(doPost, 500);
    }

});

</script>
</body>
</html>

